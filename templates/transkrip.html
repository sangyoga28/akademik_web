{% extends "base.html" %}

{% block title %}Transkrip Nilai - {{ mahasiswa['nama'] }}{% endblock %}

{% block content_container %}
<style>
    /* Formal Layout Styles */
    @font-face {
        font-family: 'FormalSerif';
        src: local('Times New Roman'), local('Liberation Serif'), serif;
    }

    @media print {
        @page {
            size: A4;
            margin: 15mm 15mm 20mm 15mm;
            /* Balanced margins */
        }

        body,
        html {
            background: white !important;
            margin: 0 !important;
            padding: 0 !important;
            font-family: 'FormalSerif', serif !important;
            color: black !important;
            font-size: 10pt;
            /* Slightly smaller base font for print */
        }

        .no-print,
        .navbar,
        .main-footer,
        .btn,
        .breadcrumb,
        .flash-messages {
            display: none !important;
        }

        .transcript-container {
            width: 100% !important;
            max-width: none !important;
            margin: 0 !important;
            padding: 0 !important;
            box-shadow: none !important;
        }

        .table {
            border-color: black !important;
            margin-bottom: 10px !important;
        }

        .transcript-table th,
        .transcript-table td {
            padding: 4px 6px !important;
            /* More compact cells */
            border: 1px solid black !important;
        }

        .semester-header {
            background-color: transparent !important;
            border: none !important;
            border-bottom: 1.5pt solid black !important;
            padding: 3px 0 !important;
            margin-top: 15px !important;
            box-shadow: none !important;
            page-break-after: avoid;
            /* Don't leave header alone at bottom */
        }

        .semester-section {
            page-break-inside: auto;
            /* Allow break inside if very long */
            margin-bottom: 10px;
        }

        .semester-section tr {
            page-break-inside: avoid;
            /* Don't split a single row */
        }

        .transcript-table thead {
            display: table-header-group;
            /* Repeat header on new pages if split */
        }

        .formal-header {
            margin-bottom: 20px !important;
        }

        .signature-section {
            margin-top: 30px !important;
            page-break-inside: avoid;
            /* Keep signature block together */
        }
    }

    /* Professional Serif Styling (Web & Print Basics) */
    .transcript-container {
        font-family: 'FormalSerif', serif;
        color: #333;
        max-width: 900px;
        margin: 2rem auto;
        padding: 40px;
        background: white;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
    }

    .formal-header {
        text-align: center;
        border-bottom: 3px double black;
        padding-bottom: 10px;
        margin-bottom: 30px;
    }

    .formal-header h1 {
        font-size: 1.6rem;
        font-weight: bold;
        margin-bottom: 3px;
        text-transform: uppercase;
    }

    .formal-header h2 {
        font-size: 1.3rem;
        margin-bottom: 5px;
    }

    .formal-header p {
        margin-bottom: 1px;
        font-size: 0.85rem;
    }

    .info-table td {
        padding: 2px 0;
        font-size: 0.95rem;
    }

    .semester-header {
        border-bottom: 1px solid black;
        padding: 5px 0;
        margin-top: 25px;
        font-weight: bold;
        text-transform: uppercase;
        display: flex;
        justify-content: space-between;
    }

    .transcript-table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 5px;
    }

    .transcript-table th,
    .transcript-table td {
        border: 1px solid #333;
        padding: 6px;
        font-size: 0.9rem;
    }

    .signature-section {
        margin-top: 40px;
    }
</style>

<div class="transcript-container">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages no-print">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mb-4" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <div class="no-print mb-4 text-end">
        <button onclick="window.print()" class="btn btn-primary px-4"><i class="bi bi-printer me-2"></i> Cetak
            Transkrip</button>
    </div>

    <div class="formal-header">
        <h1>KEMENTERIAN PENDIDIKAN DAN KEBUDAYAAN</h1>
        <h2 class="h4 fw-bold">UNIVERSITAS SISTEM INFORMASI AKADEMIK</h2>
        <p>Alamat: Jl. Raya Kebahagiaan No. 123, Tangerang, Banten</p>
        <p>Telp: (021) 1234567 | Website: www.akademik-app.ac.id</p>
    </div>

    <div class="text-center mb-4">
        <h3 class="fw-bold text-decoration-underline" style="font-size: 1.3rem;">TRANSKRIP NILAI AKADEMIK</h3>
    </div>

    <div class="row mb-4">
        <div class="col-7">
            <table class="w-100 info-table">
                <tr>
                    <td width="35%">Nama Mahasiswa</td>
                    <td>: <strong>{{ mahasiswa['nama'] }}</strong></td>
                </tr>
                <tr>
                    <td>Nomor Induk Mahasiswa</td>
                    <td>: {{ mahasiswa['nim'] }}</td>
                </tr>
                <tr>
                    <td>Program Studi</td>
                    <td>: {{ mahasiswa['prodi'] }}</td>
                </tr>
                <tr>
                    <td>Fakultas</td>
                    <td>: {{ mahasiswa['fakultas'] or '-' }}</td>
                </tr>
            </table>
        </div>
        <div class="col-5">
            <table class="w-100 info-table">
                <tr>
                    <td width="50%">IPK Kumulatif</td>
                    <td>: <strong>{{ "{:.2f}".format(ipk) }}</strong></td>
                </tr>
                <tr>
                    <td>SKS Kumulatif</td>
                    <td>: {{ total_sks }} SKS</td>
                </tr>
                <tr>
                    <td>Tanggal Cetak</td>
                    <td>: {{ current_date }}</td>
                </tr>
            </table>
        </div>
    </div>

    <div class="transcript-content">
        {% for sem, data in transkrip_per_semester.items() %}
        <div class="semester-section">
            <div class="semester-header">
                <span>SEMESTER {{ sem }}</span>
                <span>IPS: {{ "{:.2f}".format(data['ips']) }} | SKS: {{ data['sks_semester'] }}</span>
            </div>

            <table class="transcript-table">
                <thead>
                    <tr class="align-middle text-center">
                        <th width="5%">NO</th>
                        <th width="15%">KODE</th>
                        <th width="50%" class="text-start">MATA KULIAH</th>
                        <th width="10%">SKS</th>
                        <th width="10%">NILAI</th>
                        <th width="10%">BOBOT</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mk in data['matkul'] %}
                    <tr class="align-middle text-center">
                        <td>{{ loop.index }}</td>
                        <td>{{ mk['kode_matkul'] }}</td>
                        <td class="text-start">{{ mk['nama_matkul'] }}</td>
                        <td>{{ mk['sks'] }}</td>
                        <td class="fw-bold">{{ mk['nilai_huruf'] or '-' }}</td>
                        <td>{{ mk['bobot'] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>

    <!-- Official Signature Block -->
    <div class="signature-section">
        <div class="row">
            <div class="col-7">
                <p class="small text-muted" style="margin-top: 50px;">
                    * Transkrip ini adalah sah dan dicetak melalui sistem informasi akademik.<br>
                    * Dokumen dicetak pada: {{ current_date }}
                </p>
            </div>
            <div class="col-5 text-center">
                <p>Tangerang, {{ current_date }}<br>A.n Rekor,<br>Ketua Program Studi {{ mahasiswa['prodi'] }}</p>
                <div style="height: 80px;"></div>
                <p class="fw-bold text-decoration-underline text-uppercase">__________________________</p>
                <p class="mb-0">NIP. .............................</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}