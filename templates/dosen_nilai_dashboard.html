{% extends 'base.html' %}

{% block title %}Input Nilai Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="bi bi-pencil-square"></i> Dashboard Input Nilai</h4>
            </div>
            <div class="card-body">

                <!-- Filter Periode -->
                <form method="GET" action="{{ url_for('dosen_nilai_dashboard') }}"
                    class="row g-3 mb-4 p-3 bg-light rounded border">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Semester</label>
                        <select name="semester" class="form-select" onchange="this.form.submit()">
                            {% for i in range(1, 9) %}
                            <option value="{{ i }}" {% if semester==i %}selected{% endif %}>Semester {{ i }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Tahun Ajaran</label>
                        <select name="tahun_ajaran" class="form-select" onchange="this.form.submit()">
                            <option value="2023/2024" {% if tahun_ajaran=='2023/2024' %}selected{% endif %}>2023/2024
                            </option>
                            <option value="2024/2025" {% if tahun_ajaran=='2024/2025' %}selected{% endif %}>2024/2025
                            </option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Program Studi</label>
                        <select name="prodi" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Semua Prodi --</option>
                            {% for p in daftar_prodi %}
                            <option value="{{ p }}" {% if p==prodi_filter %}selected{% endif %}>{{ p }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100"><i class="bi bi-filter"></i> Terapkan
                            Filter</button>
                    </div>
                </form>

                <div class="alert alert-info border-start border-4 border-info">
                    <i class="bi bi-info-circle-fill me-2"></i> Pilih Mata Kuliah untuk input nilai mahasiswa
                    pada periode <strong>Sem {{ semester }} - {{ tahun_ajaran }}</strong>.
                    <hr>
                    <small><i class="bi bi-shield-check me-1"></i> Hanya mahasiswa yang telah <strong>Lunas
                            Pembayaran</strong> yang akan muncul di daftar input nilai.</small>
                </div>

                <!-- Search Bar -->
                <div class="mb-4 position-relative">
                    <input type="text" id="searchInput" class="form-control form-control-lg ps-5"
                        placeholder="Cari Mata Kuliah atau Kode..." onkeyup="filterMatkul()">
                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary"></i>
                </div>

                <!-- List Mata Kuliah Berdasarkan Kategori -->
                <div id="matkulList">
                    {% for prodi, matkul_list_in_prodi in matkul_per_prodi.items() %}
                    <div class="prodi-category-section mb-5">
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-grow-1 border-bottom border-primary border-2">
                                <h4 class="mb-1 text-primary fw-bold">
                                    <i class="bi bi-mortarboard-fill"></i> {{ prodi }}
                                </h4>
                            </div>
                            <span class="badge bg-primary ms-3">{{ matkul_list_in_prodi|length }} Mata Kuliah</span>
                        </div>

                        <div class="row">
                            {% for matkul in matkul_list_in_prodi %}
                            <div class="col-md-6 mb-3 matkul-card">
                                <div class="card h-100 hover-shadow border-primary">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div>
                                                <h5 class="card-title text-primary fw-bold">{{ matkul['nama_matkul'] }}
                                                </h5>
                                                <h6 class="card-subtitle mb-2 text-muted">{{ matkul['kode_matkul'] }} |
                                                    {{
                                                    matkul['sks'] }} SKS</h6>
                                            </div>
                                            <span class="badge bg-primary rounded-pill">Input <i
                                                    class="bi bi-arrow-right"></i></span>
                                        </div>
                                        <p class="card-text mt-2 small text-muted">
                                            Kelola nilai mahasiswa di kelas ini untuk semester ini.
                                        </p>
                                        <a href="{{ url_for('input_nilai', kode_matkul=matkul['kode_matkul'], semester=semester, tahun_ajaran=tahun_ajaran) }}"
                                            class="btn btn-outline-primary w-100 stretched-link">
                                            <i class="bi bi-pencil"></i> Input Nilai
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% else %}
                    <div class="col-12 text-center py-5 text-muted">
                        <i class="bi bi-emoji-frown display-4"></i>
                        <p class="mt-3">Tidak ada mata kuliah yang ditemukan untuk filter ini.</p>
                    </div>
                    {% endfor %}
                </div>

            </div>
        </div>
    </div>
</div>

<script>
    function filterMatkul() {
        const input = document.getElementById('searchInput');
        const filter = input.value.toLowerCase();
        const categories = document.getElementsByClassName('prodi-category-section');

        for (let i = 0; i < categories.length; i++) {
            const cards = categories[i].getElementsByClassName('matkul-card');
            let hasVisibleCard = false;

            for (let j = 0; j < cards.length; j++) {
                const cardBody = cards[j].getElementsByClassName('card-body')[0];
                const title = cardBody.getElementsByClassName('card-title')[0].textContent || cardBody.getElementsByClassName('card-title')[0].innerText;
                const subtitle = cardBody.getElementsByClassName('card-subtitle')[0].textContent || cardBody.getElementsByClassName('card-subtitle')[0].innerText;

                if (title.toLowerCase().indexOf(filter) > -1 || subtitle.toLowerCase().indexOf(filter) > -1) {
                    cards[j].style.display = "";
                    hasVisibleCard = true;
                } else {
                    cards[j].style.display = "none";
                }
            }

            // Hide the entire category if no cards are visible
            categories[i].style.display = hasVisibleCard ? "" : "none";
        }
    }
</script>

<style>
    .hover-shadow:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
    }
</style>
{% endblock %}