{% extends 'base.html' %}

{% block title %}Kartu Hasil Studi (KHS){% endblock %}

{% block content %}
<style>
    @media print {

        /* Sembunyikan elemen web yang tidak perlu */
        .no-print,
        .navbar,
        .main-footer,
        .btn,
        .flash-messages,
        .bg-light,
        form,
        .card-header .gap-2 {
            display: none !important;
        }

        /* Reset container dan body */
        body {
            background-color: white !important;
            padding: 0 !important;
            margin: 0 !important;
            color: black !important;
        }

        .container,
        .container-fluid {
            width: 100% !important;
            max-width: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .card {
            box-shadow: none !important;
            border: none !important;
            margin-bottom: 0 !important;
        }

        .card-header {
            background-color: white !important;
            color: black !important;
            border-bottom: 2px solid black !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        .card-header h4 {
            font-size: 24px !important;
            font-weight: bold !important;
            text-transform: uppercase;
        }

        /* Tabel bergaya print */
        .table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-top: 20px !important;
        }

        .table th,
        .table td {
            border: 1px solid black !important;
            padding: 8px !important;
            color: black !important;
            background-color: transparent !important;
        }

        .table thead th {
            background-color: #eee !important;
            font-weight: bold !important;
        }

        /* Hilangkan badge warna saat cetak */
        .badge {
            border: none !important;
            background-color: transparent !important;
            color: black !important;
            padding: 0 !important;
            font-weight: bold !important;
        }

        /* Ringkasan IPS */
        .display-4 {
            font-size: 30px !important;
            color: black !important;
        }

        .card.bg-success {
            background-color: white !important;
            color: black !important;
            border: 1px solid black !important;
        }

        .card.bg-success h6,
        .card.bg-success small {
            color: black !important;
            opacity: 1 !important;
        }
    }
</style>

<div class="row">
    <div class="col-md-12">
        <div class="card shadow-lg border-0">
            <div class="card-header bg-primary text-white py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="bi bi-journal-check"></i> Kartu Hasil Studi (KHS)</h4>
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('manage_krs', nim=mahasiswa['nim'], semester=semester, tahun_ajaran=tahun) }}"
                            class="btn btn-sm btn-light no-print">
                            <i class="bi bi-pencil-square"></i> Kelola KRS Semester Ini
                        </a>
                        <span class="badge bg-warning text-dark">{{ semester }} / {{ tahun }}</span>
                    </div>
                </div>
            </div>
            <div class="card-body p-4">

                <!-- Header Info Mahasiswa & Filter -->
                <div class="row mb-4 border-bottom pb-4">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <td width="120" class="text-muted">Nama</td>
                                <td class="fw-bold">: {{ mahasiswa['nama'] }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">NIM</td>
                                <td class="fw-bold">: {{ mahasiswa['nim'] }}</td>
                            </tr>
                            <tr>
                                <td class="text-muted">Program Studi</td>
                                <td class="fw-bold">: {{ mahasiswa['prodi'] }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="bg-light p-3 rounded border">
                            <form method="GET" action="{{ url_for('lihat_khs') }}" class="row g-2 align-items-end">
                                {% if request.args.get('nim') %}
                                <input type="hidden" name="nim" value="{{ request.args.get('nim') }}">
                                {% endif %}
                                <div class="col-9">
                                    <label class="form-label small text-muted text-uppercase fw-bold">Periode
                                        Akademik</label>
                                    <div class="input-group input-group-sm">
                                        <select name="semester" class="form-select border-primary">
                                            {% for i in range(1, 9) %}
                                            <option value="{{ i }}" {% if semester==i %}selected{% endif %}>Semester {{
                                                i }}</option>
                                            {% endfor %}
                                        </select>
                                        <select name="tahun" class="form-select border-primary"
                                            style="max-width: 120px;">
                                            <option value="2023/2024" {% if tahun=='2023/2024' %}selected{% endif %}>
                                                2023/2024</option>
                                            <option value="2024/2025" {% if tahun=='2024/2025' %}selected{% endif %}>
                                                2024/2025</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <label class="form-label small text-muted d-block">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary btn-sm w-100 shadow-sm">
                                        <i class="bi bi-funnel"></i> Filter
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Tabel Nilai -->
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light text-center">
                            <tr>
                                <th width="5%">No</th>
                                <th width="15%">Kode MK</th>
                                <th width="40%" class="text-start">Mata Kuliah</th>
                                <th width="10%">SKS</th>
                                <th width="15%">Nilai Angka</th>
                                <th width="15%">Nilai Huruf</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set ns = namespace(total_sks=0) %}
                            {% for row in data %}
                            {% set ns.total_sks = ns.total_sks + row['sks'] %}
                            <tr>
                                <td class="text-center">{{ loop.index }}</td>
                                <td class="text-center">{{ row['kode_matkul'] }}</td>
                                <td class="fw-bold">{{ row['nama_matkul'] }}</td>
                                <td class="text-center">{{ row['sks'] }}</td>
                                <td class="text-center text-muted">
                                    {{ "{:.2f}".format(row['nilai_angka']) if row['nilai_angka'] is not none else '-' }}
                                </td>
                                <td class="text-center">
                                    {% if row['nilai_huruf'] == 'A' %}
                                    <span class="badge bg-success w-50">A</span>
                                    {% elif row['nilai_huruf'] == 'B' %}
                                    <span class="badge bg-primary w-50">B</span>
                                    {% elif row['nilai_huruf'] == 'C' %}
                                    <span class="badge bg-warning text-dark w-50">C</span>
                                    {% elif row['nilai_huruf'] == 'D' %}
                                    <span class="badge bg-danger w-50">D</span>
                                    {% elif row['nilai_huruf'] == 'E' %}
                                    <span class="badge bg-dark w-50">E</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-5 text-muted">
                                    <img src="https://cdn-icons-png.flaticon.com/512/7486/7486744.png" width="64"
                                        class="mb-3 opacity-50">
                                    <p class="mb-0">Belum ada data nilai untuk semester ini.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="bg-light">
                            <tr>
                                <td colspan="3" class="text-end fw-bold">Total SKS Diambil:</td>
                                <td class="text-center fw-bold">{{ ns.total_sks }}</td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- Ringkasan IPK -->
                <div class="row mt-4 justify-content-end">
                    <div class="col-md-4">
                        <div class="card bg-success text-white border-0 text-center py-3">
                            <h6 class="mb-1 opacity-75">Indeks Prestasi Semester (IPS)</h6>
                            <h1 class="display-4 fw-bold mb-0">{{ ips }}</h1>
                            <small class="opacity-75">Sangat Memuaskan</small>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-5 no-print">
                    <a href="{{ url_for('cetak_khs', nim=mahasiswa['nim'], semester=semester, tahun=tahun) }}"
                        target="_blank" class="btn btn-outline-dark">
                        <i class="bi bi-printer"></i> Cetak KHS (Preview & PDF)
                    </a>
                </div>

            </div>
        </div>
    </div>
</div>
{% endblock %}